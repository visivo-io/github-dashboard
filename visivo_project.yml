name: Github Metrics

models:
  - name: opened github pull requests
    sql: |
      SELECT 
          action, 
          repository:name::varchar as name, 
          pull_request:user:login::varchar as author
          FROM GITHUB 
        WHERE pull_request IS NOT NULL AND
        number IS NOT NULL AND 
        action = 'opened'
  - name: submitted github pull requests reviews
    sql: |
      SELECT 
          action, 
          repository:name::varchar as name, 
          review:user:login::varchar as reviewer
          FROM GITHUB 
        WHERE review IS NOT NULL AND
        action = 'submitted'

traces:
  - name: Pull Request by Repository
    model: ref(opened github pull requests)
    cohort_on: name
    target_name: "{{env_var('GITHUB_TARGET')}}"
    props:
      type: bar
      x: query( name )
      y: query( count(*) )
  - name: Pull Request by User
    model: ref(opened github pull requests)
    cohort_on: author
    target_name: "{{env_var('GITHUB_TARGET')}}"
    props:
      type: bar
      x: query( author )
      y: query( count(*) )
  - name: Pull Request Reviews by Repository
    model: ref(submitted github pull requests reviews)
    cohort_on: name
    target_name: "{{env_var('GITHUB_TARGET')}}"
    props:
      type: bar
      x: query( name )
      y: query( count(*) )
  - name: Pull Request Reviews by User
    model: ref(submitted github pull requests reviews)
    cohort_on: reviewer
    target_name: "{{env_var('GITHUB_TARGET')}}"
    props:
      type: bar
      x: query( reviewer )
      y: query( count(*) )

charts:
  - name: Pull Requests by Repository
    traces:
      - ref(Pull Request by Repository)
    layout:
      title: "Pull Request by Repository"
  - name: Pull Requests by User
    traces:
      - ref(Pull Request by User)
    layout:
      title: "Pull Request by User"
  - name: Pull Requests Reviews by Repository
    traces:
      - ref(Pull Request Reviews by Repository)
    layout:
      title: "Pull Request Reviews by Repository"
  - name: Pull Requests Reviews by User
    traces:
      - ref(Pull Request Reviews by User)
    layout:
      title: "Pull Request Reviews by User"
